name: Build and Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize]

env:
  API_IMAGE_NAME: minimalapi
  SPRING_API_IMAGE_NAME: javaspringapi

jobs:
  build-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build MinimalAPI Podman image
        run: podman build -t ${{ env.API_IMAGE_NAME }}:latest .
        working-directory: ./MinimalAPI

      - name: Save MinimalAPI Podman image as artifact
        run: podman save ${{ env.API_IMAGE_NAME }}:latest -o ${{ env.API_IMAGE_NAME }}.tar

      - name: Upload MinimalAPI image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.API_IMAGE_NAME }}-image
          path: ${{ env.API_IMAGE_NAME }}.tar
          retention-days: 3

  build-spring-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build JavaSpringAPI Podman image
        run: podman build -t ${{ env.SPRING_API_IMAGE_NAME }}:latest .
        working-directory: ./JavaSpringAPI

      - name: Save JavaSpringAPI Podman image as artifact
        run: podman save ${{ env.SPRING_API_IMAGE_NAME }}:latest -o ${{ env.SPRING_API_IMAGE_NAME }}.tar

      - name: Upload JavaSpringAPI image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SPRING_API_IMAGE_NAME }}-image
          path: ${{ env.SPRING_API_IMAGE_NAME }}.tar
          retention-days: 3
    
  trivy-scan-api:
    runs-on: ubuntu-latest
    needs: build-api
    steps:
      - name: Download MinimalAPI image
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.API_IMAGE_NAME }}-image
          path: .

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/download/v0.65.0/trivy_0.65.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.65.0_Linux-64bit.deb

      - name: Run Trivy vulnerability scanner on API
        run: |
          trivy image --format json --output trivy-api-report.json --input ${{ env.API_IMAGE_NAME }}.tar
          trivy image --format table --input ${{ env.API_IMAGE_NAME }}.tar

      - name: Upload Trivy API scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results-api
          path: trivy-api-report.json
          retention-days: 3

  owasp-zap-scan:
    runs-on: ubuntu-latest
    needs: build-api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Podman image
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.API_IMAGE_NAME }}-image
          path: .

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Load and run Podman container
        run: |
          podman load -i ${{ env.API_IMAGE_NAME }}.tar
          podman run -d -p 8080:8080 --name test-app ${{ env.API_IMAGE_NAME }}:latest

          # Wait for the application to be ready
          echo "Waiting for application to start..."
          sleep 20

          # Check if the application is responding
          for i in {1..30}; do
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Attempt $i: Application not ready yet, waiting..."
            sleep 5
          done

          # Final check
          curl -f http://localhost:8080/health || (echo "Application failed to start" && podman logs test-app && exit 1)

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: "http://localhost:8080"
          docker_name: "ghcr.io/zaproxy/zaproxy:stable"
          allow_issue_writing: false
          fail_action: false

      - name: Upload OWASP ZAP scan results
        uses: actions/upload-artifact@v4
        with:
          name: owasp-zap-scan-results
          path: report_html.html
          retention-days: 3
        if: always()

      - name: Stop Podman container
        run: podman stop test-app
        if: always()